<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" lang="zh_CN">
		<title>新建笔记</title>
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<!-- 引入 Bootstrap -->
		<link rel="stylesheet" href="../css/bootstrap.min.css" />
		<!-- HTML5 Shim 和 Respond.js 用于让 IE8 支持 HTML5元素和媒体查询 -->
		<!-- 注意： 如果通过 file://  引入 Respond.js 文件，则该文件无法起效果 -->
		<!--[if lt IE 9]>
		<script type="text/javascript" src="../js/html5shiv.js" ></script>
		<script type="text/javascript" src="../js/respond.min.js" ></script>
      <![endif]-->
		<!-- jQuery文件。务必在bootstrap.min.js 之前引入 -->
		<script type="text/javascript" src="../js/jquery.min.js"></script>

		<!-- include codemirror (codemirror.css, codemirror.js, xml.js, formatting.js)-->
		<link rel="stylesheet" href="../js/CodeMirror/lib/codemirror.css">
		<link rel="stylesheet" href="../js/CodeMirror/theme/eclipse.css">

		<script type="text/javascript" src="../js/bootstrap.min.js"></script>
		<script type="text/javascript" src="../js/qiao.js"></script>
		<link rel="stylesheet" href="../css/summernote.css" />
		<script type="text/javascript" src="../js/summernote.min.js"></script>
		<script type="text/javascript" src="../js/summernote-zh-CN.js"></script>
		<script type="text/javascript" src="../js/code-prettify/prettify.js"></script>
		<link rel="stylesheet" href="../js/code-prettify/prettify.css" />
		<link rel="stylesheet" href="../js/select2/select2.min.css" />
		<script type="text/javascript" src="../js/select2/select2.min.js"></script>
		<script type="text/javascript" src="../js/jquery.scrollToTop.min.js"></script>
		<link rel="stylesheet" href="../css/style.css" />
		<!--AadminLTE基本资源-->
		<link rel="stylesheet" href="../css/font-awesome.min.css" />
		<script type="text/javascript" src="../js/AdminLTE/dist/js/app.js"></script>
	</head>

<body>
<div class="container" id="app">
<div class="row clearfix">
	<a href="#top" id="toTop"></a>
	<nav class="navbar navbar-inverse" role="navigation">
		<div class="navbar-header">
			<a class="navbar-brand" href="#">个人学习笔记网</a>
		</div>
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				<li>
					<a href="../index.html">首页</a>
				</li>
				<li class="active">
					<a href="#">新建笔记</a>
				</li>
				<li>
					<a href="../public/allType.html">全部分类</a>
				</li>
				<li>
					<a href="#">高级搜索</a>
				</li>
			</ul>
			<form class="navbar-form navbar-left" role="search">
				<div class="form-group">
					<input type="text" class="form-control" placeholder="搜索笔记..." />
				</div> <button type="submit" class="btn btn-default">搜索</button>
			</form>
			<ul class="nav navbar-nav navbar-right">
				<li>
					<a href="../kingmaster/index.html">登录</a>
				</li>
				<li>
					<a href="#">网站导航</a>
				</li>
			</ul>
		</div>
	</nav>
</div>
<!--The Header End-->

<div class="row clearfix" style="margin-bottom: -15px; margin-top: -15px;">
	<div class="box box-primary">
		<div class="box-header with-border">
			<div class="text-center">
				<h3 class="box-title pull-left">新建笔记</h3>
			</div>
			<div class="box-tools pull-right">
				<button type="button" class="btn btn-box-tool" data-widget="collapse">
					<i class="fa fa-minus"></i>
				</button>
			</div>
		</div>
		<!-- /.box-header -->
		<div class="box-body">
			<form class="form-inline text-center">
				<div class="form-group" style="margin-bottom: 20px;">
					<label>标题：</label>
				</div>
				<div class="form-group" style="margin-bottom: 20px;">
					<input type="text" size="50"  name="title"
						   class="form-control" onkeyup="checkStringLength(50,
						   'input[name=title]','标题长度不能大于30')"
						   placeholder="请输入笔记标题..." />
				</div><br />

				<div class="form-group">
					<label>主分类：</label>
				</div>
				<div class="form-group">
					<select id="mainType" class="js-example-data-array form-control">
					</select>
				</div>
				<div class="form-group">
					<a href="javascript:addMType()">添加</a>
				</div>

				<div class="form-group">
					<label>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;子分类：</label>
				</div>
				<div class="form-group">
					<select id="childType" class="js-example-data-array form-control">
					</select>
				</div>
				<div class="form-group">
					<a href="javascript:addCHType();">添加</a>
				</div>

				<div class="form-group">
					<label>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;分享状态：</label>
				</div>
				<div class="form-group">
					<div class="btn-group-sm" id="share" data-toggle="buttons">
						<label class="btn btn-default active" style="height: 27px;">
						<input type="radio" name="share" class="toggle" value="0" checked="checked"> 分享
					</label>
						<label class="btn btn-default" style="height: 27px;">
						<input type="radio" name="share" class="toggle" value="1">不分享
					</label>
					</div>
				</div>
			</form>
		</div>

		<div class="" >
			<div class="summernote" id="summernote"></div>
		</div>
	</div>
	<div class="row text-center" style="margin-bottom: 20px;">
		<label class="btn btn-default" id="btn_view">预览</label>
		<label class="btn btn-default" id="btn_edit">编辑</label>
		<label class="btn btn-default" ng-click="saveData(1)" id="btn_save">保存</label>
	</div>
</div>
<!--富文本编辑器结束-->
<div class="row">
	<div class="col-md-12 text-center footer">
		<span class="common">
	Copyright &copy;2017 湖南城市学院
	<a class="common" href="http://www.hncu.net" target="_blank">hncu.net</a>
	All Rights Reserved.
 </span>
	</div>
</div>
<!--底部声明结束-->
		</div>
		<script type="text/javascript" src="../js/CodeMirror/lib/codemirror.js"></script>
		<script type="text/javascript" src="../js/CodeMirror/mode/javascript/javascript.js"></script>
		<script type="text/javascript" src="../js/CodeMirror/mode/xml/xml.js"></script>
		<script type="text/javascript" src="../js/CodeMirror/mode/htmlmixed/htmlmixed.js"></script>
		<script type="text/javascript" src="../js/CodeMirror/mode/xml/xml.js"></script>
		<script type="text/javascript" src="../js/CodeMirror/addon/fold/xml-fold.js"></script>
		<script type="text/javascript" src="../js/CodeMirror/addon/edit/closetag.js"></script>
		<script type="text/javascript" src="../js/CodeMirror/addon/edit/closebrackets.js"></script>
		<script type="text/javascript" src="../js/app.js"></script>
		<script type="text/javascript">
		var mainData = [];
		var childData = [];
		$(function() {
			changSelect1(undefined,function () {
				changSelect2(mainData[0].id);
                $('#summernote').summernote(noteConf);
                //返回顶部代码
                $("#toTop").scrollToTop(800);
			});
		});

		var changSelect1 = function (chid,callback) {
			$("#mainType").html('');
			mainData = [];
			$.ajax({
				type:'post',
				url:'getMainType',
				data:null,
				success:function (data) {
					$.each(data,function () {
						var tmp = {id:this.id,text:this.typename};
						mainData.push(tmp);
					});
				},
				complete:function () {
					$("#mainType").select2({
						data: mainData,
					});
					if(typeof(chid) !== "undefined"){
						$("#mainType").select2().
						val(chid).trigger("change");
					}
					if (typeof callback === "function"){
						//alert(callback);
						callback();
					}
				}
			});
		}

		/**
		 * 根据主id实现二级联动
		 * @param id
		 */
		var changSelect2  = function (id,chid) {
			$("#childType").html('');
			childData = [];
			$.ajax({
				type:'post',
				url:'getChildType',
				data:{mid:id},
				success:function (data) {
					$.each(data,function () {
						var tmp = {id:this.id,text:this.typename};
						childData.push(tmp);
					});
				},
				complete:function () {
					$("#childType").select2({
						data: childData,
					});
					if(typeof(chid) !== 'undefined'){
						$("#childType").select2().
						val(chid).trigger("change");
					}
				}
			});
		}

        //select2的选项更改事件，只有选项值改变时才触发事件
        $('#mainType').on('select2:select', function (evt) {
            //获取选中值的id
            var id =$('#mainType').select2("val");
            changSelect2(id);
        });

        var addMType = function () {
            qiao.bs.dialog({
                id : "addMType",
                url : 'addMainTypeStatic.htm',
                title : '添加笔记主分类',
                okbtn : '提交',
                keyboard : false,
                backdrop : false
            },function () {
                var $form = $('#addMType').find('form');
                var data = {
                    typeName:$form.find("input[name=typename]").val(),
                    description:$form.find("textarea[name=description]").val()
                };
                $.ajax({
                    type: "post",
                    url: "addMainType",
                    data:data,
                    async: true,
                    xhrFields: {
                        withCredentials: true
                    },
                    success: function(result) {
                        changSelect1(result.id,function () {
                            changSelect2(result.id);
                        });
                    }
                });
                return true;
            });
        }

        var addCHType = function () {
            var mid=$('#mainType').select2("val");
            qiao.bs.dialog({
                id : "addCHType",
                url : 'addChildType.htm',
                title : '添加笔记子分类',
                okbtn : '提交',
                keyboard : false,
                backdrop : false
            },function () {
                var $form = $('#addCHType').find('form');
                var data = {
                    typeName:$form.find("input[name=typename]").val(),
                    description:$form.find("textarea[name=description]").val(),
                    mid:mid
                };
                $.ajax({
                    type: "post",
                    url: "addChild",
                    data:data,
                    async: true,
                    xhrFields: {
                        withCredentials: true
                    },
                    success: function(result) {
                        changSelect2(mid,result.id);
                    }
                });
                return true;
            });
        }

		//预览视图
		$("#btn_view").click(function() {
			var makrup = $('#summernote').summernote('code');
			makrup = makrup.replace(
			    new RegExp('<script[^]*>[\\s\\S]*?</' + 'script>', 'gi'), '');
			console.log(removeHTMLTag(makrup));
			$('#summernote').summernote('code', makrup);
			$('#summernote').summernote('destroy');
		});
		//编辑视图
		$("#btn_edit").click(function() {
			noteConf['height'] = 'auto';
			noteConf['focus'] = false;
			$('#summernote').summernote(noteConf);
		});

		//去除字符串里面的html标签
		function removeHTMLTag(str) {
			str = str.replace(/<\/?[^>]*>/g, ''); //去除HTML tag
			str = str.replace(/[ | ]*\n/g, ''); //去除行尾空白\n
			str = str.replace(/\n[\s| | ]*\r/g, ''); //去除多余空行\n
			str = str.replace(/&nbsp;/ig, ''); //去掉空格
			str = str.replace(/&gt;/ig, ">"); //替换成'>'
			str = str.replace(/&lt;/ig, "<"); //替换成'<'
			str = str.replace(/&quot;/ig, "\""); //替换成'"'
			str = str.replace(/&#39;/ig, "\""); //替换成'"'
			str = str.replace(/&#9;/ig, ""); //替换tab
			str = str.replace(/&amp;/ig, "&"); //替换&
			str = str.replace(/&times;/ig, "×"); //替换*
			str = str.replace(/&divide;/ig, "÷"); //替换除号
			str = str.replace(/&copy;/ig, "©"); //替换版权
			str = str.replace(/&reg;/ig, "®"); //替换商标注册
			str = str.replace(/(^\s+)|(\s+$)/g,""); //去除行尾和行首空白
			str = str.replace(/\s/g,"");//去除行内空白
			return str;
		}

		$("#btn_save").click(function() {
			var data = {
				title:$("input[name=title]").val(),
				mid : $('#mainType').select2("val"),
				chid: $('#childType').select2("val"),
				description : $('#summernote').summernote('code'),
				simpleDesc : removeHTMLTag($('#summernote').summernote('code')),
				share: $(":radio[name=share]:checked").val()
			}
			$.ajax({
				type:"post",
				url:"addNote",
				data:data,
				success:function (result) {
					qiao.bs.confirm({
						id:result.id,
						title:'添加成功',
						msg:'是否继续添加?',
						okbtn:'继续添加',
						qubtn:'结果预览',
						keyboard:false,
						close:false
					},function () {
                        $("input[name=title]").val('');
                        noteConf['height'] = '300';
                        noteConf['focus'] = true;
                        $('#summernote').summernote(noteConf);
                        $('#summernote').summernote('code', '');
					},function () {
						window.location.href='next.html?id='+result.id;
					});
				}
			});
//                $('#summernote').summernote('pasteHTML', '<a>Hello</a>');
		});



		var checkStringLength = function(lg,option,msg) {
			var content = $(option).val();
			if (content.length > lg) {
				qiao.bs.alert({
					id : 'temp_'+msg.length,
					title: '提示信息',
					msg: '描述信息长度不能超过'+lg,
				},function () {
					return true;
				});
				$(option).val(content.substring(0, lg));
			}
		}
		</script>
	</body>

</html>