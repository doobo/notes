<!--已删除笔记列表-->
<div class="col-sm-12" id="app" xmlns:v-bind="http://www.w3.org/1999/xhtml">
	<div class="box box-primary">
		<div class="box-header with-border ui-sortable-handle">
			<form class="form-inline" onsubmit="return false;">
				<div class="form-group">
					<button onclick="changeAll(0)" class="btn btn-primary search-btn">
						<i class="fa  fa-rotate-left"></i>恢复所选
					</button>
				</div>
				<div class="form-group">
					<button onclick="changeAll(2)" class="btn btn-primary search-btn">
						<i class="fa  fa-trash"></i>彻底删除
					</button>
				</div>
				<div class="form-group">
					<select class="form-control">
						<option>笔记标题</option>
						<option>所属账号</option>
					</select>
				</div>
				<div class="form-group">
					<input  type="text" class="form-control" placeholder="请输入搜索内容...">
				</div>
				<div class="form-group">
					<button class="btn btn-primary search-btn">
						<i class="fa fa-search"></i>查询
					</button>
				</div>
			</form>
			<!-- /.box-tools -->
		</div>
		<!-- /.box-header -->
		<div class="box">
			<table class="table table-hover">
				<tbody>
				<tr>
					<th><input type="checkbox" name="allCheck"
					onclick="checkAll('allCheck','childBox')"></th>
					<th>笔记标题</th>
					<th>所属账号</th>
					<th>笔记类别</th>
					<th>注册日期</th>
					<th>管理工具</th>
				</tr>
				</tbody>
				<tbody v-for="(delNote,index) in delNotes">
				<tr v-if="delNote[0] !== -1">
					<td><input type="checkbox" name="childBox" v-model="checks" v-bind:value="index"></td>
					<td>{{delNote[1]}}</td>
					<td>{{delNote[3]}}</td>
					<td>{{delNote[2]}}</td>
					<td>{{moment(delNote[4]).format('YYYY-MM-DD HH:mm:ss')}}</td>
					<td>
						<a v-bind:href="'../static/next.html?id='+delNote[0]" target="_blank"
						   class="btn btn-default btn-xs fa fa-comment-o">详细</a>
						<button @click="recover(index)" class="btn btn-default btn-xs fa fa-rotate-left">恢复</button>
						<button @click="del(index,2)" class="btn btn-default btn-xs fa fa-trash">彻底删除</button>
					</td>
				</tr>
				</tbody>
			</table>
			<!--</div>-->
			<div style="text-align:center;">
				<ul id="pagination-demo" class="pagination-sm"></ul>
			</div>
		</div>
	</div>
</div>
<script>
    //获取指定页面的参数
    var nextPage = function(nextPage,pageSize,callback){
        $.ajax({
            type:"post",
            url:'getDelNotes',
            data:{
                curPage:nextPage,
                pageSize:pageSize
            },
            success:function (result) {
                data.delNotes = result.delNotes;
                data.pageSize = result.pageSize;
                data.curPage = result.curPage;
                data.pageCount = result.pageCount;
                data.count = result.count;
            },
            complete:function () {
                if(typeof callback === "function"){
                    callback();
                }
            }
        });
    }

    /**
     * 复选框全选或全不选的函数
     * @param {Object} allName 全选框的name，字符参数-'name'
     * @param {Object} childName 子复选框的name，字符参数-'name'
     */
    function checkAll(allName, childName) {
        var isChecked = $("input[name='" + allName + "']").prop("checked");
        if(isChecked){
            data.checks = [];
            $("input[name='" + childName + "']").each(function() {
                //$(this).prop("checked", isChecked);
                data.checks.push($(this).attr("value"));
            });
        }else{
            data.checks = [];
        }
    }


    $(function () {
        nextPage(1,5,function () {
            $('#pagination-demo').twbsPagination({
                totalPages: data.pageCount,
                visiblePages: 7,
                first:'首页',
                last:'末页',
                prev:'上一页',
                next:'下一页',
                onPageClick: function (event, page) {
                    nextPage(page,data.pageSize,function () {
                        $("input[name=allCheck]")
                            .prop("checked", false);
                        data.checks = [];
                    });
                }
            });
        });
    });

    var data = {
        pageSize:5,
        pageCount:1,
        curPage:1,
        count:0,
        delNotes:[],
        checks:[]
    }

    var vue = new Vue({
        el: '#app',
        data: data,
        methods:{
            del:function (index,status) {
                delOne(index,status);
            },
            check:function (index,status) {
                vue.$set(data.delNotes[index],4,status);
            },
            recover:function (index) {
				delOne(index,0);
            }
        }
    });

    var changeStatus = function (index,status,callback) {
        var sendData = {
            id:data.delNotes[index][0],
            status:status
        };
        $.ajax({
            type:'post',
            url:'changeStatus',
            data:sendData,
            success:function (result) {
                if(result){
                   if(typeof  callback === "function"){
                       callback();
				   }
                }
            }
        });
    };

    var delOne = function (index,status) {
		if(data.delNotes[index][0] !== -1)
		    changeStatus(index,status,function () {
				vue.$set(data.delNotes[index],0,-1);
            });
    }

    var changeAll = function (status) {
        try {
            $.each(data.checks,function (index) {
                if(data.delNotes[data.checks[index]] != undefined
					&& data.delNotes[data.checks[index]][0] !== -1)
                    changeStatus(data.checks[index],status);
            });
        } catch (e) {
            console.log(e);
        } finally {
            $.each(data.checks,function (index){
                vue.$set(data.delNotes[data.checks[index]],0,-1);
            });
        }
    }

</script>